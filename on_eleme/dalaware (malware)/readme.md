# STMCTF'22 Ön Eleme

## Soru İsmi:
`Dalaware`


## Kategori:
- `malware`


## Soru:

```
TR:
Sistemimize bir zararlı yazılım bulaştı. Ne yaptığını bulabilir misin?
--

EN:
Our system has infected with a malicious software. Can you find what it has done?
--
```

---

## Çözüm:

Bir debugger aracılığı ile dosya açılır ve incelenir.
TLS callback fonksiyonunda ve main'de bulunan IsDebuggerPresent kontrolü yamalandıktan analize devam edilir.

![ss1](./solution/1.png "ss1")

Main fonksiyonunda büyük bir döngü olduğu ve dalaware_p.573D00 fonksiyonunun 3 kere çağırıldığı görülür.

![ss2](./solution/2.png "ss2")

dalaware_p.573D00 fonksiyonu incelendiğinde GetLogicalDriveStringsW fonksiyonu ile bilgisayara bağlı mantıksal diklerin listelendiği, GetDriveType fonksiyonu ile disklerin çıkarılabilir disk olup olmadığı kontrol edildiği ve çıkarılabilir disklerin işaretlendiği 26 karakterlik bir string oluşturulduğu tespit edilir.

main fonksiyonu incelenmeye devam edilir ve ve 2 döngüye daha rastlanır. Döngülerin benzer olduğu fakat birinin bir fonksiyon çağırdığı diğerinin ise konsola bir yazı yazdığı görülür.

![ss3](./solution/3.png "ss3")

dalaware_p.573B60 fonksiyonu incelendiğinde dalaware_p.573850 fonksiyonu çalıştırılıp dönen değerin main fonksiyonuna benzer bir şekilde konsola yazıldığı görülür.

![ss4](./solution/4.png "ss4")

dalaware_p.573850 fonksiyonu incelendiğinde ise, E diskinin içindeki dosyalarının isimlerinin kontrol edilip "System Volume Information" ve "88f6504ed8d8d27c2d066f05951f4a3f17520bdf.txt" stringleri ile karşılaştırıldığı görülür. Fonksiyon sonunda bir sayı döndürdüğü görülür ve bu sayı diskteki dosya sayısı olduğu, kontrol edilen "System Volume Information" ve "88f6504ed8d8d27c2d066f05951f4a3f17520bdf.txt" dosyalarının bu sayıya etki etmediği tespit edilir.

![ss5](./solution/5.png "ss5")

Burada ekrana "I : %c, %d" stringi basıldıktan sonra 573C33 adresindeki jump komutu yamalanarak dalaware_p.573320 fonksiyonuna girilir.

![ss6](./solution/6.png "ss6")

dalaware_p.573320 fonksiyonu incelendiğinde CreateFileW fonksiyonu ile E diskinin açıldığı ve DeviceIoControl fonksiyonu ile E diskinin fiziksel disk numarasına erişildiği görülür.

internal const UInt32 IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS = 0x00560000;

![ss7](./solution/7.png "ss7")

dalaware_p.573320 fonksiyonunun devamında fiziksel diskin CreateFileW fonksiyonu ile açıldığı görülür.

![ss8](./solution/8.png "ss8")


Fiziksel diskin açıldıktan sonra DeviceIoControl fonksiyonlarında mantıksal diskin kitlendiği ve çıkartıldığı görülür.

public const int FSCTL_LOCK_VOLUME = 0x00090018;

public const int FSCTL_DISMOUNT_VOLUME = 0x00090020;

Daha sonra WriteFile fonksiyonunun aynı diske bir veri yazdığı görülür.

Bu adımdan sonra zararlı yazılımın takılan bir flash belleğe veri yazdığı görülünce sanal makineye içinde sadece 88f6504ed8d8d27c2d066f05951f4a3f17520bdf.txt dosyası oluşturulmuş bir flash bellek takılarak zararlı yazılımın çalışması sağlanır ve bilgisayar flash bellek üzerinden boot edilerek flag'e ulaşılır.


![img0](./solution/img0.jpg "img0")

Diğer bir seçenek olarak analize devam edilir. WriteFile fonksiyonu parametrelerine bakıldığında diske 512 bytelık bir veri yazıldığı görülür ve veriye memory kısmından erişilerek "Binary -> Save to a File" özelliği ile bir dosyaya yazılır.

![ss9](./solution/9.png "ss9")

İlgili dosya IDA ile 16 bit modunda açılarak biraz düzenlemeler yapıldıktan sonra anlaşılabilir assembly koduna ulaşılır.

![ss10](./solution/10.png "ss10")

Kod incelendiğinde bir stringin xor ile değiştirildiği görülür.
String 0x28 değeri ile xorlanarak flag'e ulaşılır.

![ss11](./solution/11.png "ss11")

MBR kodunun orjinaline data.asm dosyasından ulaşılabilir.
