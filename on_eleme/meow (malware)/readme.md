# STMCTF'22 Ön Eleme

## Soru İsmi:
`meow`


## Kategori:
- `Malware`


## Soru:

```
TR:

EN:

```

---

## Çözüm:

Paket sayısının çok olduğu bir pcap dosyası bulunmaktadır. İncelenmeye TCP protokolündeki verilerin ne olduğu kontrol edilerek başlanmaktadır. Data olarak filtrelendiği zaman, 4444 ve 8888 gibi shell bağlantısında sıklıkla kullanılan portların kullanıldığını görülmektedir.

![ss1](./solution/1.png "ss1")

4444 portunun TCP akışı filtrelendiği zaman, pcap içerisinde ssl key log dosyasının bulunmasını isteyen bir diyaloğun olduğu görülmektedir.

![ss2](./solution/2.png "ss2")

8888 portunun TCP akışı filtrelendiği zaman ssl key log dosyası elde edilmektedir.

![ss3](./solution/3.png "ss3")

Şifrelenmiş trafik açıldığı zaman yapılan işlem trafiğin içerisinde herhangi bir dosyanın varlığının kontrol edilmesidir.Bununla beraber **hayatbeninedenyoruyorsunmademcokgunahoyunusenbozuyorsun.exe** çalıştırılabilir dosyasını tespit edilmektedir.

![ss4](./solution/4.png "ss4")

Dosyanın indirilme işlemine ait HTTP akış görüntüsü aşağıdaki gibidir.

![ss5](./solution/5.png "ss5")

Dosya incelenmeye başlandığında, bir çok anti debug, anti vm ve anti analiz tekniklerinin kullanıldığı görülmektedir.

![ssmain](./solution/main.png "ssmain")
![ssmain2](./solution/main2.png "ssmain2")

Anti tekniklerden biri olan **IsDebuggerPresent()** fonksiyonunun, PEB yapısındaki BeingDebugged ait flag değerinin patchlenmesi ile ilgili kontrol atlatılmaktadır. 

![ss6](./solution/6.png "ss6")

Diğer anti tekniklerde aynı şekilde patchlendikten sonra, stringslerde kullanıldığı fark edilen **advobfuscator** obfuscation aracının kullanıldığı görülmektedir. Bu araca ait, deobfuscation işleminden sonra **explorer.exe** stringi elde edilmektedir.

![ss7](./solution/7.png "ss7")

Ardından explorer.exe'nin Process ID değeri tespit edilmeye çalışılmaktadır.

![ss8](./solution/8.png "ss8")

Process ID değeri bulunduktan sonra, **iblis.keser** domaininin **30303** portundan bağlantı açıldığı ve **GET** komutunun gönderilmesi ile sunucudan veri alındığı görülmektedir. Alınan verinin şifreli bir shellcode olduğu görülmektedir.

![ss9](./solution/9.PNG "ss9")
![ss10](./solution/10.PNG "ss10")

İncelenmeye devam edildiğinde bir diğer deobfuscation işleminin yapıldığı görülmektedir. Bu işlemden sonra **ZenitsuAgatsuma** stringi elde edilmektedir.

![ss11](./solution/11.png "ss11")

**ZenitsuAgatsuma**'nın ilk harfi ile şifreli shellcode çözülmeye çalışılmaktadır.

![ss12](./solution/12.png "s12")

Şifreli shellcode çözüldükten sonraki hali aşağıdaki gibidir.

![ss13](./solution/13.png "ss13")

Analiz edilmeye devam edildiğinde, tekrar bir deobfuscation işleminin yapıldığı sonrasında **init** stringinin elde edildiği ve GetProcAddress() fonksiyonu ile aynı işlemi yapan fonksiyon ile init fonksiyonuna ait adresin bulunduğu görülmektedir. Buradan şifresi çözülen shellcode'un dll olduğu ve export fonksiyonu olan **init** fonksiyonunun çağrıldığı görülmektedir.

![ss14](./solution/14.png "ss14")

Dll içerisinde de deobfuscation işleminin yapıldığı görülmektedir. Deobfuscation işleminden sonra **esenyurttrap2.merso** ve **meow.php** stringleri elde edilmektedir.

![ss15](./solution/15.png "ss15")

**8080** portu üzerinden **esenyurttrap2.merso**'nun **meow.php** dizinine internet bağlantısı yapılmaya çalışıldığı görülmektedir.

![ss16](./solution/16.png "ss16")

**meow.php** dosyasına yapılan **POST** isteği aşağıdaki gibidir..

![ss17](./solution/17.png "ss17")

**pass=**, **s3nm4k1n4s1n** ve **&watching=%3E%3E** stringlerinin de aynı şekilde deobfuscate edildiği görülmektedir.

![ss18](./solution/18.png "ss18")
![ss19](./solution/19.png "ss19")
![ss20](./solution/20.png "ss20")

**OfflineisComing!** stringinin rc4() şifreleme algoritmasında,**s3nm4k1n4s1n** stringini şifrelemek için anahtar olarak kullanıldığı görülmektedir.

![ss21](./solution/21.png "ss21")

rc4() algoritması ile şifrelenmiş **s3nm4k1n4s1n** stringinin karşılığı olarak **e¦K³å~.ÂI.úr** stringi gözükmektedir.

![ss22](./solution/22.png "ss22")

**Content-Type: application/x-www-form-urlencoded**, **https://esenyurttrap2.merso:8080** ve **ceb37a03b805deac04c8205693b51d36key=b20f96e5878b0a47ff8626c8f757e35b** stringler aynı şekilde deobfuscate edilmiştir.

![ss23](./solution/23.png "ss23")
![ss24](./solution/24.png "ss24")
![ss25](./solution/25.png "ss25")

Bu işlemlerden sonra **ceb37a03b805deac04c8205693b51d36key=b20f96e5878b0a47ff8626c8f757e35b** cookie değeri HTTP isteğine eklenmektedir.

![ss26](./solution/26.png "ss26")
![ss27](./solution/27.png "ss27")

HTTP isteği gönderildikten sonra dönen cevabın başarılı bir şekilde okunduğu görülmektedir.

![ss28](./solution/28.png "ss28")

Giden isteğin HTTP akışı aşağıdaki gibidir.

![sshttp](./solution/http.png "sshttp")

**pass=** değişkeninin rc4() şifreleme algoritmasından dönen değerinin **e¦K³å~.ÂI.úr** olduğu görülmektedir. Trafik şifreli bir şekilde iletişim kurmadığı için, **s3nm4k1n4s1n** stringi rc4() algoritmasından dönen şifreli değeriyle gönderilmektedir. İstek atılan url kontrol edildiğinde bir giriş sayfasının olduğu gözükmektedir.  

![ss29](./solution/29.png "ss29")

Bu giriş sayfasına **s3nm4k1n4s1n** ile girildiğinde WSO Web Shell karşımıza çıkmaktadır. Web Shellin sadece dizin listeleme özelliğinin açık olduğu görülmektedir. 

![ss30](./solution/30.png "ss30")

**/home/meow** dizinine gidildiğinde **flag.txt** dosyasının içeriği okunduğunda flag elde edilmektedir.

